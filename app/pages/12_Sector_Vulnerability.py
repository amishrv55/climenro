import streamlit as st
import pandas as pd
import plotly.express as px
import os
import sys

# ✅ Set Streamlit page config (must be first)
st.set_page_config(page_title="🔬 Sector Vulnerability", layout="wide")

# --- Path setup ---
current_dir = os.path.dirname(os.path.abspath(__file__))
scripts_dir = os.path.abspath(os.path.join(current_dir, "..", "..", "scripts"))
if scripts_dir not in sys.path:
    sys.path.append(scripts_dir)

# --- Import modules ---
from sector_vulnerability import (
    load_sector_vulnerability_data,
    get_sector_vulnerability_by_country,
    get_latest_sector_scores
)

# --- Load data ---
@st.cache_data
def load_data():
    return load_sector_vulnerability_data()

df = load_data()

# --- Country Selector ---
countries = sorted(df["Name"].dropna().unique())
selected_country = st.selectbox("🌍 Select Country", countries, index=countries.index("India") if "India" in countries else 0)

# --- Tabs ---
tab0, tab1, tab2 = st.tabs([
    "📘 Overview",
    "📈 Sector Trend",
    "📊 Latest Snapshot"
])

# ----------------------------
# 📘 Tab 0: Overview
# ----------------------------
with tab0:
    st.markdown("## 📘 Module Overview: Sector-wise Climate Vulnerability")
    st.markdown("""
    This module visualizes **sectoral climate vulnerability** for countries based on the **ND-GAIN Sectoral Indicators**.

    ### 🔍 What It Shows
    - Vulnerability trends over time across sectors (e.g., health, water, agriculture)
    - Latest scores by sector for selected country
    - Comparison of sectors most at risk

    ### 🧪 Methodology
    - **Data Source:** ND-GAIN Sectoral Vulnerability Dataset (Notre Dame Global Adaptation Initiative)
    - Scores range from **0 (low vulnerability)** to **1 (high vulnerability)**
    - Indicators include exposure, sensitivity, and adaptive capacity across sectors

    ### 🧭 How to Use
    1. Use the **country selector** to pick a country of interest
    2. Explore **historical vulnerability trends** by sector in Tab 2
    3. View **latest sector-wise scores** in Tab 3

    ### 🌍 Significance
    This helps policymakers and analysts:
    - Identify **high-risk sectors** needing adaptation investments
    - Track how vulnerabilities change over time
    - Compare resilience gaps across countries

    ---
    """)

# ----------------------------
# 📈 Tab 1: Vulnerability Trends
# ----------------------------
with tab1:
    st.markdown(f"## 📈 Vulnerability Trends by Sector – {selected_country}")
    trend_df = get_sector_vulnerability_by_country(df, selected_country)

    fig = px.line(
        trend_df,
        x="year",
        y="score",
        color="sector",
        title=f"ND-GAIN Vulnerability Over Time – {selected_country}",
        markers=True,
        labels={"score": "Vulnerability Score", "year": "Year"}
    )
    st.plotly_chart(fig, use_container_width=True)

# ----------------------------
# 📊 Tab 2: Latest Snapshot
# ----------------------------
with tab2:
    st.markdown(f"## 📊 Latest Sector-wise Vulnerability – {selected_country}")

    latest_df = get_latest_sector_scores(df)
    latest_country = latest_df[latest_df["Name"] == selected_country]

    # Data Table
    st.dataframe(
        latest_country[["sector", "score"]]
        .set_index("sector")
        .sort_values("score", ascending=False),
        use_container_width=True
    )

    # Bar Chart
    fig_bar = px.bar(
        latest_country,
        x="sector",
        y="score",
        color="sector",
        title=f"Latest Vulnerability Scores by Sector – {selected_country}",
        labels={"score": "Vulnerability Score", "sector": "Sector"}
    )
    st.plotly_chart(fig_bar, use_container_width=True)

# ----------------------------
# Footer
# ----------------------------
st.markdown("---")
st.caption("🔬 Climenro | Sectoral Vulnerability | Source: ND-GAIN Sector Indicators (Notre Dame Global Adaptation Initiative)")
